<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { margin:0; font-family: system-ui, "Noto Sans Thai", sans-serif; background:#f7f7f8; color:#111; }
    header { padding:16px; border-bottom:1px solid #e5e7eb; background:#fff; }
    main { padding:16px; max-width: 880px; margin:0 auto; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
    label { font-weight:600; display:block; margin-bottom:6px; }
    input, select { width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px; }
    .row { display:grid; gap:12px; }
    @media (min-width: 640px) { .row-2 { grid-template-columns: 1fr 1fr; } .row-3 { grid-template-columns: 1fr 1fr 1fr; } }
    .muted { color:#6b7280; }
    .out { background:#fafafa; border:1px dashed #e5e7eb; border-radius:12px; padding:12px; }
    button { background:#0ea5e9; color:#fff; border:0; padding:10px 14px; border-radius:10px; font-weight:700; }
    button[disabled] { opacity:.5; }
    .err { color:#b91c1c; font-size:.9em; min-height:1em; }
    .ok { color:#16a34a; font-size:.9em; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#eef6ff; color:#0369a1; font-size:.9em; }
  </style>
</head>
<body>
  <header>
    <h2 style="margin:0;">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h2>
    <p class="muted" style="margin:4px 0 0;">‡∏™‡πÅ‡∏Å‡∏ô‚Äì‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‚Äì‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° DPT ‡πÅ‡∏•‡∏∞ RP ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
  </header>

  <main>
    <div class="card">
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px;">
        <button id="scanQR">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô JobN.</button>
        <div id="qr-reader" style="width:300px;"></div>
        <span class="muted">QR ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: a||b||c||d ‡∏à‡∏∞‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ a ‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö‚Äù</span>
      </div>

      <div class="row row-2">
        <div>
          <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö</label>
          <input id="round" readonly placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô">
        </div>
        <div>
          <label>‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô</label>
          <input id="jobCode" readonly placeholder="‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å DPT!C ‡πÇ‡∏î‡∏¢ match ‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö">
        </div>
      </div>

      <div class="row row-3" style="margin-top:12px;">
        <div>
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï</label>
          <input id="need" readonly placeholder="DPT!G ‚àí RP!H ‡∏£‡∏ß‡∏° (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ RP ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ DPT!G)">
        </div>
        <div>
          <label>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
          <select id="step">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô --</option>
            <!-- ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å DPT!E ‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô -->
          </select>
        </div>
        <div>
          <label>Oper (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)</label>
          <input id="oper" readonly placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">
        </div>
      </div>

      <div class="row row-2" style="margin-top:12px;">
        <div>
          <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï</label>
          <input id="startedAt" readonly placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏™‡πà‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï">
        </div>
        <div>
          <label>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</label>
          <input id="machine" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)">
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <input id="modelName" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏î ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ">
        </div>
      </div>

      <div class="out" style="margin-top:12px;">
        <div class="muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</div>
        <div id="status"></div>
      </div>

      <div style="margin-top:12px;">
        <button id="startBtn" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï</button>
        <span id="submitStatus" class="muted" style="margin-left:12px;"></span>
      </div>
    </div>
  </main>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycby-_xFYg--QuuMYYM0sCzsESu1aH3Ga4uDRRXWmnSDAg4jKwzsVALwIWI4Wj2uVYKoGxA/exec';

    const els = {
      round: document.getElementById('round'),
      jobCode: document.getElementById('jobCode'),
      need: document.getElementById('need'),
      step: document.getElementById('step'),
      oper: document.getElementById('oper'),
      startedAt: document.getElementById('startedAt'),
      machine: document.getElementById('machine'),
      modelName: document.getElementById('modelName'),
      status: document.getElementById('status'),
      startBtn: document.getElementById('startBtn'),
      submitStatus: document.getElementById('submitStatus'),
      scanQRBtn: document.getElementById('scanQR'),
      qrReaderDiv: document.getElementById('qr-reader')
    };

    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡πÅ‡∏Å‡∏ô QR
    els.scanQRBtn.addEventListener('click', () => {
      els.qrReaderDiv.innerHTML = '';
      const qr = new Html5Qrcode("qr-reader");
      qr.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          qr.stop();
          const round = decodedText.split('||')[0].trim();
          els.round.value = round;
          els.machine.value = round; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
          els.status.innerHTML = `<span class="ok">‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span> <span class="pill">${round}</span>`;
          // ‡∏´‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å DPT/RP
          if (round) {
            loadRoundInfo(round);
          }
        },
        () => {}
      ).catch(err => {
        els.status.innerHTML = `<span class="err">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${err}</span>`;
      });
    });

    function validateReady() {
      const roundOk = !!els.round.value.trim();
      const stepOk = !!els.step.value.trim();
      const needOk = els.need.value.trim() !== '';
      els.startBtn.disabled = !(roundOk && stepOk && needOk);
    }

    async function fetchJSON(url, payload) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö: jobCode, needQty, steps (‡∏à‡∏≤‡∏Å DPT ‡πÅ‡∏•‡∏∞ RP)
    async function loadRoundInfo(round) {
      els.status.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å DPT/RP...';
      try {
        const data = await fetchJSON(GAS_URL, { action:'roundInfo', round });
        // ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á: { ok:true, jobCode:'...', planG:number, rpHsum:number, need:number, steps:['op1','op2',...] }
        if (!data || !data.ok) throw new Error(data && data.msg ? data.msg : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');

        els.jobCode.value = data.jobCode || '';
        els.need.value = typeof data.need === 'number' ? data.need : '';
        // ‡πÄ‡∏ï‡∏¥‡∏° dropdown ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
        els.step.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô --</option>' + (data.steps || []).map(s => `<option value="${s}">${s}</option>`).join('');

        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const plan = typeof data.planG === 'number' ? data.planG : 0;
        const rpHsum = typeof data.rpHsum === 'number' ? data.rpHsum : 0;
        els.status.innerHTML = `<span class="ok">DPT!G=${plan}, RP!H(‡∏£‡∏ß‡∏°)=${rpHsum}, ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï=${data.need}</span>`;

        validateReady();
      } catch (err) {
        els.status.innerHTML = `<span class="err">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</span>`;
        els.jobCode.value = '';
        els.need.value = '';
        els.step.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô --</option>';
        validateReady();
      }
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡πá‡∏ï Oper ‡πÄ‡∏ó‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    els.step.addEventListener('change', () => {
      els.oper.value = els.step.value || '';
      validateReady();
    });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å RP
    els.startBtn.addEventListener('click', async () => {
      validateReady();
      if (els.startBtn.disabled) return;
      const now = new Date().toISOString();
      els.startedAt.value = now;
      els.submitStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      const payload = {
        action: 'start',
        round: els.round.value.trim(),
        jobCode: els.jobCode.value.trim(),
        oper: els.oper.value.trim(),     // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        stepName: els.step.value.trim(), // redundancy ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        machine: els.machine.value.trim(),
        modelName: els.modelName.value.trim(),
        startedAt: now
      };

      try {
        const res = await fetchJSON(GAS_URL, payload);
        if (res && res.ok) {
          els.submitStatus.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÅ‡∏ñ‡∏ß ${res.rowIndex}${res.inserted ? ' - ‡πÅ‡∏ó‡∏£‡∏Å‡πÉ‡∏´‡∏°‡πà' : ''})`;
        } else {
          throw new Error(res && res.msg ? res.msg : '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
        }
      } catch (err) {
        els.submitStatus.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`;
      }
    });
  </script>
</body>
</html>
