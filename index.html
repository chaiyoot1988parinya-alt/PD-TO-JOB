<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï (PDT/RP)</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { margin:0; font-family: system-ui, "Noto Sans Thai", sans-serif; background:#f7f7f8; color:#111; }
    header { padding:16px; border-bottom:1px solid #e5e7eb; background:#fff; }
    main { padding:16px; max-width: 860px; margin:0 auto; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
    label { font-weight:600; display:block; margin-bottom:6px; }
    input, select { width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px; }
    .row { display:grid; gap:12px; }
    @media (min-width: 640px) { .row-2 { grid-template-columns: 1fr 1fr; } }
    .muted { color:#6b7280; }
    .out { background:#fafafa; border:1px dashed #e5e7eb; border-radius:12px; padding:12px; }
    button { background:#0ea5e9; color:#fff; border:0; padding:10px 14px; border-radius:10px; font-weight:700; }
    button[disabled] { opacity:.5; }
    .err { color:#b91c1c; font-size:.9em; min-height:1em; }
    .ok { color:#16a34a; font-size:.9em; }
  </style>
</head>
<body>
  <header>
    <h2 style="margin:0;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï</h2>
    <p class="muted" style="margin:4px 0 0;">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö PDT ‡πÅ‡∏•‡∏∞ RP ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
  </header>

  <main>
    <div class="card">
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô QR -->
      <div style="margin-bottom:12px;">
        <button id="scanQR">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏à‡πä‡∏≠‡∏ö</button>
        <div id="qr-reader" style="width:300px; margin-top:12px;"></div>
      </div>

      <div class="row row-2">
        <div>
          <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏à‡πä‡∏≠‡∏ö</label>
          <input id="job" readonly>
        </div>
        <div>
          <label>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
          <select id="step">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô --</option>
            <option value="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô A">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô A</option>
            <option value="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô B">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô B</option>
            <option value="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô C">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô C</option>
          </select>
        </div>
      </div>

      <div class="row row-2" style="margin-top:12px;">
        <div>
          <label>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</label>
          <select id="machine">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ --</option>
            <option value="MC-01">MC-01</option>
            <option value="MC-02">MC-02</option>
            <option value="MC-03">MC-03</option>
          </select>
        </div>
        <div>
          <label>Oper (‡∏à‡∏≤‡∏Å PDT!E)</label>
          <input id="oper" readonly>
        </div>
      </div>

      <div class="row row-2" style="margin-top:12px;">
        <div>
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å PDT!G</label>
          <input id="pdtG" readonly>
        </div>
        <div>
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï</label>
          <input id="need" readonly>
        </div>
      </div>

      <div class="out" style="margin-top:12px;">
        <div class="muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</div>
        <div id="status"></div>
      </div>

      <div style="margin-top:12px;">
        <button id="startBtn" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï</button>
        <span id="submitStatus" class="muted" style="margin-left:12px;"></span>
      </div>
    </div>
  </main>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzgfr2UNQ_ITkVen1Rd4LJJFMXvQ_14-fnLs8H7dD2X090VPy4wgvFL4irVhh5Eyon_-w/exec';

    const els = {
      job: document.getElementById('job'),
      step: document.getElementById('step'),
      machine: document.getElementById('machine'),
      oper: document.getElementById('oper'),
      pdtG: document.getElementById('pdtG'),
      need: document.getElementById('need'),
      status: document.getElementById('status'),
      startBtn: document.getElementById('startBtn'),
      submitStatus: document.getElementById('submitStatus'),
    };

    function validateReady() {
      const jobOk = !!els.job.value.trim();
      const stepOk = !!els.step.value.trim();
      const needOk = els.need.value.trim() !== '';
      els.startBtn.disabled = !(jobOk && stepOk && needOk);
    }

    async function fetchJSON(url, payload) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    async function checkPDTandRP(jobNo, stepName) {
      els.status.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö PDT ‡πÅ‡∏•‡∏∞ RP...';
      const data = await fetchJSON(GAS_URL, { action:'check', jobNo, stepName });
      const hasPDT = !!(data && data.pdt);
      const hasRP = !!(data && data.rp && typeof data.rp.Hsum === 'number');

      if (!hasPDT) {
        els.status.innerHTML = '<span class="err">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô PDT</span>';
        els.oper.value = ''; els.pdtG.value = ''; els.need.value = '';
        return { ok:false };
      }

      const oper = data.pdt.E || '';
      const pdtG = Number(data.pdt.G || 0);
      const rpHsum = hasRP ? Number(data.rp.Hsum) : 0;
      const need = Math.max(pdtG - rpHsum, 0);

      els.oper.value = oper;
      els.pdtG.value = pdtG;
      els.need.value = hasRP ? need : pdtG;

      els.status.innerHTML = hasRP
        ? `<span class="ok">‡∏û‡∏ö RP: ‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏•‡πâ‡∏ß ${rpHsum}, ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï ${need}</span>`
        : `<span class="ok">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ RP: ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï ${pdtG}</span>`;

      return { ok:true };
    }

    els.step.addEventListener('change', async () => {
      if (!els.job.value.trim() || !els.step.value.trim()) return;
      try {
        await checkPDTandRP(els.job.value.trim(), els.step.value.trim());
      } catch (err) {
        els.status.innerHTML = `<span class="err">‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</span>`;
      }
      validateReady();
    });

    els.startBtn.addEventListener('click', async () => {
      validateReady();
      if (els.startBtn.disabled) return;
      els.submitStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const payload = {
        action: 'start',
        jobNo: els.job.value.trim(),
        oper: els.oper.value.trim(),
        stepName: els.step.value.trim(),
        machine: els.machine.value.trim(),
        startedAt: new Date().toISOString()
      };
      try {
        const res = await fetchJSON(GAS_URL, payload);
        if (res && res.ok) {
          els.submitStatus.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÅ‡∏ñ‡∏ß ${res.rowIndex}${res.inserted ? ' - ‡πÅ‡∏ó‡∏£‡∏Å‡πÉ‡∏´‡∏°‡πà' : ''})`;
        } else {
          throw new Error(res && res.msg ? res.msg : '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
        }
      } catch (err
