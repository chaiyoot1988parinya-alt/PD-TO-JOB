<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏à‡πä‡∏≠‡∏ö</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h2>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πä‡∏≠‡∏ö -->
  <button id="scanJobBtn">üì∑ ‡∏Å‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏à‡πä‡∏≠‡∏ö</button>
  <div id="qr-reader-job" style="width:300px;"></div>

  <div>
    <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏à‡πä‡∏≠‡∏ö</label>
    <input id="jobNo" readonly>
  </div>
  <div>
    <label>‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô</label>
    <input id="jobCode" readonly>
  </div>
  <div>
    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï</label>
    <input id="planQty" readonly>
  </div>
  <div>
    <label>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (WC)</label>
    <select id="wc"></select>
  </div>
  <div>
    <label>Oper</label>
    <input id="oper" readonly>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ -->
  <button id="scanMachineBtn">üì∑ ‡∏Å‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</button>
  <div id="qr-reader-machine" style="width:300px;"></div>

  <div>
    <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</label>
    <input id="machineNo" readonly>
  </div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxpNDKIzJy5aTFf31syeKzYvxB8tgEFzzuLXcNUgp1cGLT93fO1KHDh9RqgsS77w-zKPg/exec';

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å GAS
async function fetchJobInfo(jobNo) {
  const res = await fetch(GAS_URL, {
    method: "POST",
    body: new URLSearchParams({ action:"jobInfo", jobNo })
  });
  const data = await res.json();

  if (!data.ok) {
    alert(data.msg);
    return;
  }

  document.getElementById("jobCode").value = data.jobCode;
  document.getElementById("planQty").value = data.planQty;

  const wcSelect = document.getElementById("wc");
  wcSelect.innerHTML = "";
  data.wcList.forEach(wc => {
    const opt = document.createElement("option");
    opt.value = wc;
    opt.textContent = wc;
    wcSelect.appendChild(opt);
  });

  wcSelect.onchange = () => {
    const selectedWC = wcSelect.value;
    document.getElementById("oper").value = data.wcOperMap[selectedWC] || "";
  };
}

// ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏à‡πä‡∏≠‡∏ö
document.getElementById("scanJobBtn").addEventListener("click", () => {
  const qrJob = new Html5Qrcode("qr-reader-job");
  qrJob.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      qrJob.stop();
      const jobNo = decodedText.split("||")[0].trim();
      document.getElementById("jobNo").value = jobNo;
      fetchJobInfo(jobNo);
    },
    (errorMessage) => { console.log(errorMessage); }
  ).catch(err => alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err));
});

// ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£
document.getElementById("scanMachineBtn").addEventListener("click", () => {
  const qrMachine = new Html5Qrcode("qr-reader-machine");
  qrMachine.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      qrMachine.stop();
      const machineNo = decodedText.trim(); // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å QR ‡∏ï‡∏£‡∏á ‡πÜ
      document.getElementById("machineNo").value = machineNo;
    },
    (errorMessage) => { console.log(errorMessage); }
  ).catch(err => alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err));
});
</script>
</body>
</html>
